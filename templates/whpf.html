{% extends "base.html" %}
{% block content %}
  <div class="pull-left">
    <h1>WHO HE PLAY FOR</h1>
  </div>
  <div class="pull-right game-info text-right">
    <ul>
      <li>Level <span class="level"></span></li>
      <li>Round <span class="round"></span></li>
      <li>Score <small class="partial-results"><span class="guessed"></span>/<span class="total"></span></small></li>
      <li>Time left: <span class="time-left"></span></li>
    </ul>
  </div>
  <div class="game">
    <div class="row">
      <div class="col-sm-12 text-center player">
        <h2 class="player-name"></h2>
        <!-- <i class="text-success fa fa-check fa-4x guess-right"></i> -->
        <!-- <i class="text-danger fa fa-close fa-4x guess-wrong"></i> -->
        <img class="player-picture" />
      </div>
      <div class="col-sm-12 text-center">
        <h2>Your guess</h2>
        <div id="teams">
        {% for team in teams %}
          <a href="#" class="guess" data-team='{{ team|tojson }}'>
            <img data-toggle="tooltip" title="{{ team.city }} {{ team.name }}" class="team-picture" id="{{ team.code }}" src="{{ team.picture }}" />
          </a>
        {% endfor %}
        </div>
      </div>
    </div> <!-- row -->
  </div>

  <div class="row fail_results">
    <div class="col-md-12">
      <h1>What was that?</h1>
      <a class="btn btn-info btn-lg" href="{{ url_for('home') }}">Play again</a>
    </div>
  </div>
  <div class="row results">
    <div class="col-md-12">
      <h1>Final result: <span class="guessed"></span>/<span class="total"></span></h1>
      <div class="row">
        <div class="col-md-2">
          <span class="text-right">Share your result</span>
        </div>
        <div class="col-md-10">
          <input type="text" class="form-control" />
        </div>
      </div>
      <a class="btn btn-info btn-lg" href="{{ url_for('home') }}">Play again</a>
    </div>
  </div>

  <div class="row past-guesses">
    <div class="col-md-12">
      <h1>Past guesses</h1>
      <table class="table">
        <thead>
          <tr>
            <th>Round</th>
            <th>Player</th>
            <th>Your guess</th>
            <th>Correct guess</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}

{% block js %}
  <script>
    function start_timer(){
      var time_left = game_status['time_limit'];
      $(".time-left").html(time_left);
      var interval = setInterval(function(){
        time_left -= 1;
        $(".time-left").html(time_left);

        if ((time_left < 10) && (time_left > 0)){
          $(".time-left").addClass("text-danger");
          $(".time-left").animate({opacity: 0.25}).animate({opacity: 1});
        };

        if (time_left == 0){
          $(".time-left").removeClass("text-danger");
          clearInterval(interval);
          end_game();
        };
      }, 1000);
    }


    $(document).ready(function(){
      initialize();
      start_round();
      start_timer();
    });


    $("a.guess").click(function(e){
      e.preventDefault();
      var team = $(this).data("team");
      react(team);
    });


    function initialize(){
      window.player;
      window.game_status = {
        'total_rounds': 20,
        'round': 1,
        'guessed': 0,
        'level': {{ game_info.level }},
        'code': "",
        'time_limit': 60,
      };
      level_initialize();
    };


    // LEVEL
    // level 1: Sorted teams. Player with name
    // level 2: Shuffled teams. Player with name
    // level 3: Sorted teams. Player without name
    // level 4: Shuffled teams. Player without name
    function level_initialize(){
      if (game_status['level'] <= 2){
        $('.player-name').show();
      };
      $(".level").html(game_status['level']);

    };


    function level_setup(){
      if (game_status['level'] == 2 || game_status['level'] == 4){
        var parent = $("#teams");
        var children = parent.children();
        while (children.length) {
            parent.append(children.splice(Math.floor(Math.random() * children.length), 1)[0]);
        }
      }
    };


    function start_round(){
      level_setup();

      var total = game_status['round'] - 1;
      $(".guessed").html(game_status['guessed']);
      $(".total").html(total);
      $(".round").html(game_status['round']);

      var players = {{ players|tojson }};
      player = players[Math.floor(Math.random() * players.length)];

      $(".player-name").html(player.name);
      $(".player-picture").css("background-image", "url('" + player.picture + "')");

      if (total == game_status['total_rounds']){
        end_game();
      }
    };


    function advance_round(team){
      game_status['round'] += 1;
      var pad = "00000000";
      // Padded player ID
      game_status['code'] += pad.slice(0, 8 - player.id.toString().length) + player.id;
      // Team id
      game_status['code'] += team.id.toString().slice(-2);
    };

    function react(team){
      if (team.code == player.team.code){
        correct_guess(team);
      } else {
        wrong_guess(team);
      }
      advance_round(team);
    };


    function end_game(){
      // Hide the game and the partial result
      var total = game_status['round'] - 1;
      $(".guessed").html(game_status['guessed']);
      $(".total").html(total);
      $(".round").html(game_status['round']);

      $(".game").hide();

      // Add the total number of rounds to the code
      var padding = '000';
      var total_padded = padding.slice(0, padding.length-(total.toString().length)) + total.toString();
      game_status['code'] = total_padded + game_status['code'];
      game_status['code'] = game_status['level'] + game_status['code'];

      // Add an input to share the result
      input = $(".results input").val("{{ request.url_root }}" + "results/" + game_status['code']);
      var guessed = game_status['guessed'];
      var round = game_status['round'];
      if (round > 1){
        $(".results").show();
      } else {
        $(".fail_results").show();
      };
    };


    function correct_guess(team){
      game_status['guessed'] += 1;

      // $(".guess-right").fadeIn( 100 ).delay( 200 ).fadeOut(100);
      add_past_guess("success", team);
      start_round();
    };


    function wrong_guess(team){
      // $(".guess-wrong").fadeIn( 100 ).delay( 200 ).fadeOut(100);
      add_past_guess("danger", team);
      start_round();
    };


    function add_past_guess(classs, team){
      var tr = $("<tr />");
      tr.attr("class", classs);

      th_round = $("<th />", {
        "scope": "row",
        "style": "vertical-align: middle",
      }).html('<span class="fa-stack fa-2x"><i class="fa fa-circle fa-stack-2x"></i><strong class="fa-stack-1x" style="color: white;">' + game_status['round'] + '</strong></span>');
      img_player = $("<img />", {
        'src': player.picture,
        'title': player.name,
      });
      td_player = $("<td />").append(img_player);
      img_guess = $("<img />", {
        'src': team.picture,
        'title': team.city + " " + team.name,
      });
      td_your_guess = $("<td />").append(img_guess);
      img_answer = $("<img />", {
        'src': player.team.picture,
        'title': player.team.city + " " + player.team.name,
      });
      td_answer = $("<td />").append(img_answer);

      tr.append(th_round);
      tr.append(td_player);
      tr.append(td_your_guess);
      tr.append(td_answer);

      var table = $(".past-guesses tbody");
      table.prepend(tr);
      $(".past-guesses").show();
    };
  </script>

{% endblock %}
